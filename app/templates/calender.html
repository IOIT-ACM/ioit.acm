<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>College Academic Calendar | AISSMS IOIT ACM Student Chapter</title>

    <meta
      name="description"
      content="AISSMS IOIT ACM student chapter & College Academic Calendar - View upcoming ACM chapter events, college activities, academic calendar, exams, workshops, and more for IOIT students. Stay updated and never miss an important date!"
    />
    <meta
      name="keywords"
      content="AISSMS IOIT, ACM, Academic calendar, college events, academic calendar, exams, workshops, student activities, computing, technology, student chapter, Pune"
    />
    <meta name="author" content="AISSMS IOIT ACM Student Chapter" />
    <meta name="robots" content="index, follow" />
    <meta name="language" content="English" />
    <meta name="theme-color" content="#007BFF" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="IOIT ACM Calendar" />
    <meta name="mobile-web-app-capable" content="yes" />

    <meta property="og:type" content="website" />
    <meta
      property="og:title"
      content="ACM & College Academic Calendar | AISSMS IOIT"
    />
    <meta
      property="og:description"
      content="Discover all ACM and college events at AISSMS IOIT. Access the academic calendar, exam schedules, workshops, and student activities in one place."
    />
    <meta property="og:url" content="https://ioit.acm.org/calendar" />
    <meta property="og:image" content="/static/og-image.png" />
    <meta property="og:site_name" content="AISSMS IOIT ACM Calendar" />
    <meta property="og:locale" content="en_US" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content="ACM & College Academic Calendar | AISSMS IOIT"
    />
    <meta
      name="twitter:description"
      content="Stay updated with ACM and college events, academic calendar, exams, and workshops at AISSMS IOIT. All student activities in one calendar."
    />
    <meta name="twitter:image" content="/static/og-image.png" />
    <meta name="twitter:site" content="@AISSMSIOIT" />
    <meta name="twitter:creator" content="@AISSMSIOIT" />

    <link
      rel="icon"
      type="image/png"
      href="/static/favicon-96x96.png"
      sizes="96x96"
    />
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
    <link rel="shortcut icon" href="/static/favicon.ico" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/static/apple-touch-icon.png"
    />
    <link rel="manifest" href="/static/site.webmanifest" />

    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-Y6Z6G51Z27"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'G-Y6Z6G51Z27');
    </script>

    <link rel="stylesheet" href="/static/css/tailwind.css" />
    <link rel="stylesheet" href="/static/css/styles.css" />

    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.5.1/moment.min.js"></script>

    <style>
      #calendar {
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 450px;
        background-color: hsl(var(--card));
        overflow: hidden;
        border: var(--border-width-thick) solid var(--border-color-strong);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-large);
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0.5rem;
        width: 100%;
        position: relative;
        background-color: hsl(var(--card));
        border-bottom: var(--border-width-medium) solid
          var(--border-color-strong);
        text-align: center;
      }

      .header h1 {
        flex-grow: 1;
        margin: 0;
        padding: 0;
        font-size: 1.125rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: hsl(var(--foreground));
      }

      .left,
      .right {
        position: static;
        border: none;
        background: none;
        cursor: pointer;
        padding: 0.5rem;
        font-size: 1.75rem;
        line-height: 1;
        color: hsl(var(--foreground));
        font-weight: bold;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        width: 2.5rem;
      }
      .left:before {
        content: '‹';
      }
      .right:before {
        content: '›';
      }
      .left:active,
      .right:active {
        transform: translateY(1px);
      }

      .month {
        width: 100%;
        padding: 0.5rem;
        flex-grow: 1;
      }

      .week {
        display: flex;
        width: 100%;
      }

      .day {
        flex: 1;
        min-width: 0;
        padding: 0.5rem 0.25rem;
        text-align: center;
        cursor: pointer;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        border-left: 1px solid hsl(var(--border));
      }
      .week .day:first-child {
        border-left: none;
      }

      .day.other {
        color: hsl(var(--muted-foreground));
        opacity: 0.7;
      }

      .day.today .day-number {
        background-color: var(--black);
        color: var(--card);
        border-radius: 9999px;
      }

      .day-name {
        font-size: 0.65rem;
        text-transform: uppercase;
        font-weight: 600;
        color: hsl(var(--muted-foreground));
      }

      .day-number {
        font-size: 1rem;
        font-weight: 700;
        width: 1.75rem;
        height: 1.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        transition: all 0.2s ease;
      }

      .day .day-events {
        list-style: none;
        margin: 0;
        padding: 0;
        height: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 3px;
      }

      .day .day-events span {
        display: block;
        width: 6px;
        height: 6px;
        border-radius: 9999px;
      }

      .blue {
        background: rgba(156, 202, 235, 1);
      }
      .orange {
        background: rgba(247, 167, 0, 1);
      }
      .green {
        background: rgba(153, 198, 109, 1);
      }
      .yellow {
        background: rgba(249, 233, 0, 1);
      }

      .details {
        position: relative;
        z-index: 10;
        margin-top: 0.5rem;
        background: hsl(var(--secondary));
        border: var(--border-width-medium) solid var(--border-color-strong);
        border-radius: var(--radius-base);
        box-shadow: var(--shadow-small);
      }

      .arrow {
        position: absolute;
        top: -10px;
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 0 8px 8px 8px;
        border-color: transparent transparent var(--black) transparent;
        transform: translateX(-50%);
        transition: left 0.4s ease;
      }

      .events {
        padding: 0.75rem;
        max-height: 150px;
        overflow-y: auto;
      }

      .event {
        font-size: 0.875rem;
        line-height: 1.5;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0;
      }

      .event-category {
        height: 10px;
        width: 10px;
        border-radius: 9999px;
        flex-shrink: 0;
      }

      .legend {
        padding: 0.75rem;
        width: 100%;
        border-top: var(--border-width-medium) solid var(--border-color-strong);
        background: hsl(var(--card));
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 1rem;
      }

      .entry {
        position: relative;
        padding-left: 1.25rem;
        font-size: 0.75rem;
        display: inline-flex;
        align-items: center;
        color: hsl(var(--foreground));
      }

      .entry:after {
        content: '';
        position: absolute;
        height: 10px;
        width: 10px;
        top: 50%;
        transform: translateY(-50%);
        left: 0.25rem;
        border-radius: 9999px;
      }

      .entry.blue:after {
        background: rgba(156, 202, 235, 1);
      }
      .entry.orange:after {
        background: rgba(247, 167, 0, 1);
      }
      .entry.green:after {
        background: rgba(153, 198, 109, 1);
      }
      .entry.yellow:after {
        background: rgba(249, 233, 0, 1);
      }

      .month.new {
        animation: fadeIn 0.5s ease-out;
      }
      .month.in {
        animation: fadeIn 0.4s ease-out;
      }
      .month.out {
        animation: fadeOut 0.4s ease-in;
      }
      .details.in {
        animation: fadeIn 0.3s ease-out;
      }
      .details.out {
        animation: fadeOut 0.3s ease-out forwards;
      }
      .events.in {
        animation: fadeIn 0.3s 0.1s ease-out both;
      }
      .events.out {
        animation: fadeOut 0.2s ease-in both;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }
    </style>

    <style>
      :root {
        --background: 0 0% 100%;
        --foreground: 0 0% 3.9%;
        --card: 0 0% 100%;
        --card-foreground: 0 0% 3.9%;
        --primary: 0 0% 9%;
        --primary-foreground: 0 0% 98%;
        --secondary: 0 0% 96.1%;
        --muted-foreground: 0 0% 45.1%;
        --border: 0 0% 89.8%;
        --ring: 0 0% 3.9%;
        --black: rgba(0, 0, 0, 1);
        --grey: rgb(83, 83, 83);
        --border-width-medium: 2px;
        --border-width-thick: 4px;
        --border-color-strong: var(--black);
        --radius-base: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-2xl: 1.5rem;
        --shadow-small: 4px 4px 0px 0px var(--black);
        --shadow-large: 8px 8px 0px 0px var(--black);
      }
      body {
        font-family: 'Arial', Helvetica, sans-serif;
        background-color: hsl(var(--background));
        color: hsl(var(--foreground));
        background-image: linear-gradient(to bottom right, #e9d5ff, #dbeafe);
      }
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-weight: 900;
        letter-spacing: -0.025em;
      }
      .glass-brutalist-container {
        background-color: rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(1.25rem);
        -webkit-backdrop-filter: blur(1.25rem);
        border: var(--border-width-thick) solid var(--border-color-strong);
        border-radius: var(--radius-2xl);
        box-shadow: var(--shadow-large);
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-lg);
        border: var(--border-width-medium) solid var(--border-color-strong);
        font-weight: 700;
        padding: 0.75rem 1.5rem;
        transition: all 0.15s ease-in-out;
        font-size: 0.875rem;
        line-height: 1.25rem;
        cursor: pointer;
      }
      .btn:active {
        transform: translate(4px, 4px);
        box-shadow: none !important;
      }
      .btn-primary {
        background-color: var(--grey);
        color: hsl(var(--primary-foreground));
        box-shadow: var(--shadow-small);
      }
      .btn-primary:hover {
        background-color: rgb(51 65 85);
      }
      .btn-outline {
        background-color: hsl(var(--card));
        color: hsl(var(--foreground));
        box-shadow: var(--shadow-small);
      }
      .btn-outline:hover {
        background-color: hsl(var(--secondary));
      }
      .tabs-trigger:hover {
        background-color: hsl(var(--secondary));
      }
      .btn-icon {
        padding: 0.75rem;
      }
      .card {
        border: var(--border-width-thick) solid var(--border-color-strong);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-large);
        overflow: hidden;
        background-color: hsl(var(--card));
      }
      .card-header {
        padding: 1rem;
        color: white;
      }
      .card-content {
        padding: 1.5rem;
        background-color: hsl(var(--card));
      }
      .tabs-list {
        display: flex;
        background-color: hsl(var(--secondary));
        border: var(--border-width-medium) solid var(--border-color-strong);
        border-radius: var(--radius-lg);
        padding: 0.45rem;
        gap: 0.5rem;
      }
      .tabs-trigger {
        flex: 1;
        padding: 0.5rem;
        border-radius: var(--radius-base);
        font-weight: 700;
        color: hsl(var(--muted-foreground));
        transition: all 0.2s ease-in-out;
        border: 2px solid transparent;
      }
      .tabs-trigger[aria-checked='true'] {
        background-color: var(--grey);
        color: hsl(var(--primary-foreground));
        box-shadow: var(--shadow-small);
      }
      .tabs-trigger:not([aria-checked='true']):hover {
        background-color: white;
        border-color: var(--black);
      }
      .bg-gradient-video {
        background-image: linear-gradient(to bottom right, #3b82f6, #8b5cf6);
      }
      *::-webkit-scrollbar {
        display: none;
      }
      * {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <header
      class="sticky top-0 z-30 border-b-4 border-black bg-white/50 backdrop-blur-md"
    >
      <div
        class="max-w-screen-[1500px] mx-auto px-4 sm:px-6 lg:px-8"
        aria-label="Primary navigation"
      >
        <div class="flex justify-between items-center h-16 md:h-24">
          <div class="flex items-center space-x-4">
            <img
              src="{{ url_for('static', filename='img/assets/acm.png') }}"
              alt="AISSMS IOIT ACM Logo"
              class="w-auto h-10 mr-3"
            />
            <h1 class="md:text-3xl uppercase tracking-tight">
              Annual Calender
            </h1>
          </div>
          <div class="hidden md:flex items-center space-x-4">
            <button id="today-btn" class="btn btn-primary">Today</button>
            <div
              class="flex items-center border-2 border-black rounded-xl overflow-hidden shadow-sm"
            >
              <button
                id="prev-month"
                aria-label="Previous month"
                class="p-3 bg-white hover:bg-gray-200 transition-colors"
              >
                <i class="ri-arrow-left-s-line text-2xl"></i>
              </button>
              <span
                id="current-month"
                class="text-lg font-bold uppercase px-6 py-3 w-56 text-center bg-white border-x-2 border-black"
                aria-live="polite"
              >
              </span>
              <button
                id="next-month"
                aria-label="Next month"
                class="p-3 bg-white hover:bg-gray-200 transition-colors"
              >
                <i class="ri-arrow-right-s-line text-2xl"></i>
              </button>
            </div>
          </div>
          <div class="md:hidden">
            <button
              id="mobile-filter-toggle"
              aria-label="Open filters"
              class="p-2 text-black"
            >
              <i class="ri-filter-3-line text-3xl"></i>
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-screen-[1500px] mx-auto md:p-4">
      <div class="md:p-4">
        <div class="lg:grid lg:grid-cols-12 lg:gap-8">
          <aside
            id="filter-sidebar"
            class="fixed inset-0 bg-black/50 z-40 lg:z-auto lg:static lg:bg-transparent lg:block lg:col-span-3 hidden"
          >
            <div class="card bg-white w-80 lg:w-auto p-6 lg:sticky lg:top-32">
              <div class="flex justify-between items-center lg:hidden mb-6">
                <h2 class="text-2xl uppercase">Filters</h2>
                <button id="close-filters" aria-label="Close filters">
                  <i class="ri-close-line text-3xl text-black"></i>
                </button>
              </div>
              <div class="space-y-8">
                <div>
                  <label class="text-sm font-bold text-black uppercase"
                    >Event Type</label
                  >
                  <div
                    id="event-type-filter"
                    class="tabs-list mt-2"
                    role="radiogroup"
                  >
                    <button
                      role="radio"
                      aria-checked="true"
                      data-type="all"
                      class="tabs-trigger"
                    >
                      All
                    </button>
                    <button
                      role="radio"
                      aria-checked="false"
                      data-type="acm"
                      class="tabs-trigger"
                    >
                      ACM
                    </button>
                    <button
                      role="radio"
                      aria-checked="false"
                      data-type="non-acm"
                      class="tabs-trigger"
                    >
                      College
                    </button>
                  </div>
                </div>

                <div>
                  <label class="text-sm font-bold text-black uppercase"
                    >Academic Year</label
                  >
                  <div
                    id="academic-year-filter"
                    class="grid grid-cols-1 gap-3 mt-2"
                  >
                    <button data-year="FY" class="btn btn-outline w-full">
                      First Year
                    </button>
                    <button data-year="SY" class="btn btn-outline w-full">
                      Second Year
                    </button>
                    <button data-year="TY" class="btn btn-outline w-full">
                      Third year
                    </button>
                    <button data-year="FR" class="btn btn-outline w-full">
                      Fourth Year
                    </button>
                  </div>
                </div>

                <div
                  class="flex items-center justify-between pt-6 border-t-2 border-gray-200"
                >
                  <span
                    id="filter-count"
                    class="text-sm text-gray-500 font-bold"
                  ></span>
                  <button
                    id="clear-filters"
                    class="text-sm font-bold text-black hover:underline uppercase"
                  >
                    Clear All
                  </button>
                </div>
              </div>
            </div>
          </aside>

          <div class="lg:col-span-9 lg:mt-0">
            <div
              id="calendar-wrapper"
              class="flex justify-center md:hidden p-4"
            >
              <div id="calendar"></div>
            </div>

            <div class="card bg-white hidden md:block">
              <section
                id="calendar-view"
                class="hidden md:block"
                aria-labelledby="calendar-heading"
              >
                <h2 id="calendar-heading" class="sr-only">
                  Monthly Calendar View
                </h2>

                <header
                  class="grid grid-cols-7 bg-white border-b-4 border-black"
                  role="row"
                >
                  <div
                    class="p-3 text-center font-bold text-black uppercase"
                    role="columnheader"
                  >
                    Sun
                  </div>
                  <div
                    class="p-3 text-center font-bold text-black uppercase"
                    role="columnheader"
                  >
                    Mon
                  </div>
                  <div
                    class="p-3 text-center font-bold text-black uppercase"
                    role="columnheader"
                  >
                    Tue
                  </div>
                  <div
                    class="p-3 text-center font-bold text-black uppercase"
                    role="columnheader"
                  >
                    Wed
                  </div>
                  <div
                    class="p-3 text-center font-bold text-black uppercase"
                    role="columnheader"
                  >
                    Thu
                  </div>
                  <div
                    class="p-3 text-center font-bold text-black uppercase"
                    role="columnheader"
                  >
                    Fri
                  </div>
                  <div
                    class="p-3 text-center font-bold text-black uppercase"
                    role="columnheader"
                  >
                    Sat
                  </div>
                </header>

                <div class="relative">
                  <div
                    id="calendar-body"
                    class="grid grid-cols-7"
                    role="grid"
                  ></div>
                  <div
                    id="calendar-state-overlay"
                    class="absolute hidden inset-0 z-10 bg-white/80 backdrop-blur-sm p-8 text-center min-h-[50vh] flex items-center justify-center"
                    aria-live="polite"
                  ></div>
                </div>
              </section>

              <section id="agenda-view-wrapper">
                <h2 id="agenda-heading" class="sr-only">Daily Agenda View</h2>
                <div id="agenda-view"></div>
              </section>

              <div id="no-events-container" class="hidden">
                <div
                  class="text-center p-8 md:border-t-4 border-black text-gray-500"
                >
                  <i class="ri-inbox-2-line text-5xl mb-4"></i>
                  <h3 class="text-2xl font-bold uppercase">No Events Found</h3>
                  <p class="mt-2">
                    Try adjusting the filters or changing the month.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div
      id="event-modal"
      class="fixed inset-0 bg-black/80 hidden z-50"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modal-title"
    >
      <div
        class="flex items-center justify-center min-h-screen p-4"
        id="modal-backdrop"
      >
        <div
          class="card max-w-2xl w-full max-h-[90vh] flex flex-col"
          id="modal-panel"
        >
          <div
            class="card-header bg-gradient-video flex justify-between items-start border-b-4 border-black"
          >
            <h2 id="modal-title" class="text-3xl uppercase"></h2>
            <button
              id="close-modal"
              class="text-white hover:opacity-75"
              aria-label="Close event details"
            >
              <i class="ri-close-line text-3xl"></i>
            </button>
          </div>

          <div class="card-content space-y-6 overflow-y-auto no-scrollbar">
            <div class="flex flex-wrap items-center gap-x-4 gap-y-2">
              <span
                id="modal-category"
                class="px-3 py-1 text-xs font-bold uppercase rounded-md"
              ></span>
              <div id="modal-academic-years" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="flex items-start space-x-4 text-black">
              <i class="ri-calendar-event-line text-2xl mt-1"></i>
              <span id="modal-date" class="text-base font-bold"></span>
            </div>

            <div class="flex items-start space-x-4 text-black">
              <i class="ri-map-pin-line text-2xl mt-1"></i>
              <span id="modal-location" class="text-base font-bold"></span>
            </div>

            <div>
              <h3 class="text-lg uppercase mb-2">Description</h3>
              <div
                id="modal-description"
                class="text-gray-700 max-w-none"
              ></div>
            </div>
          </div>
          <div
            class="p-4 bg-white border-t-4 border-black flex md:flex-row flex-col justify-end gap-5"
          >
            <button id="share-event-btn" class="btn btn-outline">
              <i class="ri-share-line mr-2"></i>Share
            </button>
            <button id="add-to-calendar-btn" class="btn btn-primary">
              <i class="ri-add-line mr-2"></i>Add to Calendar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const API_URL = 'http://localhost:8000/events/api/events/filter/';
        const LOCAL_STORAGE_KEY = 'collegeCalendarState';

        let state = {
          currentDate: new Date(),
          filters: { eventType: 'all', academicYears: [] },
          allEvents: [],
          events: [],
          isLoading: true,
          error: null,
        };

        const DOMElements = {
          prevMonthBtn: document.getElementById('prev-month'),
          nextMonthBtn: document.getElementById('next-month'),
          todayBtn: document.getElementById('today-btn'),
          currentMonthEl: document.getElementById('current-month'),
          calendarBody: document.getElementById('calendar-body'),
          agendaView: document.getElementById('agenda-view'),
          calendarStateOverlay: document.getElementById(
            'calendar-state-overlay'
          ),
          noEventsContainer: document.getElementById('no-events-container'),
          filterSidebar: document.getElementById('filter-sidebar'),
          mobileFilterToggle: document.getElementById('mobile-filter-toggle'),
          closeFiltersBtn: document.getElementById('close-filters'),
          eventTypeFilter: document.getElementById('event-type-filter'),
          academicYearFilter: document.getElementById('academic-year-filter'),
          filterCountEl: document.getElementById('filter-count'),
          clearFiltersBtn: document.getElementById('clear-filters'),
          eventModal: document.getElementById('event-modal'),
          modalBackdrop: document.getElementById('modal-backdrop'),
          closeModalBtn: document.getElementById('close-modal'),
          modalTitle: document.getElementById('modal-title'),
          modalCategory: document.getElementById('modal-category'),
          modalAcademicYears: document.getElementById('modal-academic-years'),
          modalDate: document.getElementById('modal-date'),
          modalLocation: document.getElementById('modal-location'),
          modalDescription: document.getElementById('modal-description'),
          mobileCalendar: document.getElementById('calendar'),
        };

        const saveStateToLocalStorage = () => {
          try {
            const stateToSave = { filters: state.filters };
            localStorage.setItem(
              LOCAL_STORAGE_KEY,
              JSON.stringify(stateToSave)
            );
          } catch (e) {
            console.error('Could not save state to localStorage', e);
          }
        };

        const loadStateFromLocalStorage = () => {
          try {
            const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedState) {
              const parsed = JSON.parse(savedState);
              state.filters = parsed.filters || {
                eventType: 'all',
                academicYears: [],
              };
            }
          } catch (e) {
            console.error('Could not load state from localStorage', e);
            localStorage.removeItem(LOCAL_STORAGE_KEY);
          }
        };

        const fetchAllEvents = async () => {
          state.isLoading = true;
          render();

          const year = new Date().getFullYear();
          const startDate = new Date(year, 0, 1);
          const endDate = new Date(year, 11, 31);
          const formatDateForAPI = (date) => date.toISOString().split('T')[0];

          const requestBody = {
            start_date: formatDateForAPI(startDate),
            end_date: formatDateForAPI(endDate),
          };

          try {
            const response = await fetch(API_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(requestBody),
            });
            if (!response.ok) {
              let errorMessage = `API Error: ${response.status} ${response.statusText}`;
              try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorMessage;
              } catch (e) {}
              throw new Error(errorMessage);
            }
            const data = await response.json();
            processApiData(data);
          } catch (error) {
            console.error('Failed to fetch events:', error);
            state.error = error.message;
            state.isLoading = false;
            state.allEvents = [];
            applyFiltersAndRender();
          }
        };

        const processApiData = (data) => {
          state.allEvents = data.map((event) => {
            const start = new Date(event.start_date + 'T00:00:00');
            const end = event.end_date
              ? new Date(event.end_date + 'T00:00:00')
              : new Date(start.getTime());
            return { ...event, start, end };
          });
          state.isLoading = false;
          state.error = null;
          applyFiltersAndRender();
        };

        const applyFiltersAndRender = () => {
          const year = state.currentDate.getFullYear();
          const month = state.currentDate.getMonth();
          const monthStart = new Date(year, month, 1);
          const monthEnd = new Date(year, month + 1, 0);

          let filteredEvents = state.allEvents.filter((event) => {
            const eventStartsInMonth =
              event.start >= monthStart && event.start <= monthEnd;
            const eventEndsInMonth =
              event.end >= monthStart && event.end <= monthEnd;
            const eventSpansMonth =
              event.start < monthStart && event.end > monthEnd;
            if (!eventStartsInMonth && !eventEndsInMonth && !eventSpansMonth) {
              return false;
            }

            if (
              state.filters.eventType !== 'all' &&
              event.category !== state.filters.eventType
            ) {
              return false;
            }

            if (
              state.filters.academicYears.length > 0 &&
              !state.filters.academicYears.some((yr) =>
                event.academic_years.includes(yr)
              )
            ) {
              return false;
            }

            return true;
          });

          state.events = filteredEvents;
          saveStateToLocalStorage();
          render();
        };

        const getTextColorForBg = (hexColor) => {
          if (!hexColor || hexColor.length < 7) return 'text-black';
          const r = parseInt(hexColor.substr(1, 2), 16);
          const g = parseInt(hexColor.substr(3, 2), 16);
          const b = parseInt(hexColor.substr(5, 2), 16);
          const yiq = (r * 299 + g * 587 + b * 114) / 1000;
          return yiq >= 128 ? 'text-black' : 'text-white';
        };

        const formatDate = (date, options) =>
          date.toLocaleDateString('en-US', options);

        const render = () => {
          renderHeader();
          renderFilters();
          renderDesktopCalendar();
          renderMobileCalendar();
        };

        const renderHeader = () => {
          DOMElements.currentMonthEl.textContent = formatDate(
            state.currentDate,
            { month: 'long', year: 'numeric' }
          );
        };

        const renderFilters = () => {
          DOMElements.eventTypeFilter
            .querySelectorAll('button')
            .forEach((btn) => {
              btn.setAttribute(
                'aria-checked',
                state.filters.eventType === btn.dataset.type
              );
            });

          DOMElements.academicYearFilter
            .querySelectorAll('button')
            .forEach((btn) => {
              const isActive = state.filters.academicYears.includes(
                btn.dataset.year
              );
              btn.classList.toggle('btn-primary', isActive);
              btn.classList.toggle('btn-outline', !isActive);
            });

          const count =
            (state.filters.eventType !== 'all' ? 1 : 0) +
            state.filters.academicYears.length;
          DOMElements.filterCountEl.textContent =
            count > 0
              ? `${count} FILTER${count > 1 ? 'S' : ''} ON`
              : 'No filters';
          DOMElements.clearFiltersBtn.style.display =
            count > 0 ? 'block' : 'none';
        };

        const renderDesktopCalendar = () => {
          DOMElements.calendarStateOverlay.classList.add('hidden');
          DOMElements.noEventsContainer.classList.add('hidden');
          DOMElements.agendaView.innerHTML = '';

          if (state.isLoading) {
            renderSkeletonCalendar();
          } else if (state.error) {
            showErrorState(state.error);
          } else {
            renderDesktopCalendarGrid(state.events);
            renderMobileAgenda(state.events);
            if (state.events.length === 0) {
              showEmptyState();
            }
          }
        };

        const renderSkeletonCalendar = () => {
          const year = state.currentDate.getFullYear();
          const month = state.currentDate.getMonth();
          const firstDayOfMonth = new Date(year, month, 1);
          const lastDayOfMonth = new Date(year, month + 1, 0);
          const firstDayOfWeek = firstDayOfMonth.getDay();

          DOMElements.calendarBody.innerHTML = '';

          for (let i = 0; i < firstDayOfWeek; i++) {
            const paddingCell = document.createElement('div');
            paddingCell.className =
              'border-r border-b border-gray-200 bg-gray-50 min-h-[9rem]';
            DOMElements.calendarBody.appendChild(paddingCell);
          }

          for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
            const dayEl = document.createElement('div');
            dayEl.className =
              'min-h-[9rem] relative p-1 border-r border-b border-gray-200 flex flex-col';
            dayEl.innerHTML = `
              <span class="text-sm font-bold text-gray-500 w-7 h-7 flex items-center justify-center rounded-full">${day}</span>
              <div class="mt-1 flex-grow overflow-hidden space-y-2 p-1">
                <div class="h-5 bg-gray-200 rounded animate-pulse"></div>
                <div class="h-5 bg-gray-200 rounded animate-pulse w-2/3"></div>
              </div>`;
            DOMElements.calendarBody.appendChild(dayEl);
          }
        };

        const renderDesktopCalendarGrid = (events) => {
          const year = state.currentDate.getFullYear();
          const month = state.currentDate.getMonth();
          const firstDayOfMonth = new Date(year, month, 1);
          const lastDayOfMonth = new Date(year, month + 1, 0);
          const firstDayOfWeek = firstDayOfMonth.getDay();

          DOMElements.calendarBody.innerHTML = '';

          for (let i = 0; i < firstDayOfWeek; i++) {
            const paddingCell = document.createElement('div');
            paddingCell.className =
              'border-r border-b border-gray-200 bg-gray-50 min-h-[9rem]';
            DOMElements.calendarBody.appendChild(paddingCell);
          }

          const dayCells = [];

          for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
            const date = new Date(year, month, day);
            const dayEl = document.createElement('div');
            dayEl.className =
              'min-h-[9rem] relative p-1 border-r border-b border-gray-200 flex flex-col';
            dayEl.setAttribute('role', 'gridcell');
            dayEl.setAttribute(
              'aria-label',
              formatDate(date, {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
              })
            );

            const dayNumber = document.createElement('span');
            dayNumber.textContent = day;
            dayNumber.className =
              'text-sm font-bold text-gray-500 w-7 h-7 flex items-center justify-center rounded-full';

            if (date.toDateString() === new Date().toDateString()) {
              dayNumber.className =
                'bg-black text-white w-7 h-7 flex items-center justify-center font-bold rounded-full';
            }

            dayEl.appendChild(dayNumber);

            const eventsWrapper = document.createElement('div');
            eventsWrapper.className =
              'mt-1 flex-grow overflow-y-auto no-scrollbar space-y-1';
            dayEl.appendChild(eventsWrapper);

            DOMElements.calendarBody.appendChild(dayEl);

            dayCells[day - 1] = dayEl;
          }

          events.forEach((event) => {
            const startDate = new Date(event.start);
            const endDate = new Date(event.end);
            const currentDate = new Date(startDate);

            while (currentDate <= endDate) {
              if (
                currentDate.getMonth() === month &&
                currentDate.getFullYear() === year
              ) {
                const dayNumber = currentDate.getDate();
                const dayCell = dayCells[dayNumber - 1];
                if (dayCell) {
                  const eventEl = createEventElement(event);
                  dayCell.querySelector('.flex-grow').appendChild(eventEl);
                }
              }
              currentDate.setDate(currentDate.getDate() + 1);
            }
          });
        };

        const createEventElement = (event) => {
          const eventEl = document.createElement('button');
          eventEl.className = `w-full text-left p-1.5 text-xs font-bold uppercase rounded-md border-2 border-transparent hover:border-black transition-colors`;
          eventEl.style.backgroundColor = event.color;
          eventEl.classList.add(getTextColorForBg(event.color));
          eventEl.textContent = event.title;
          eventEl.setAttribute(
            'aria-label',
            `${event.title}, ${formatDate(event.start, {
              month: 'short',
              day: 'numeric',
            })}`
          );
          eventEl.onclick = () => showEventModal(event);
          return eventEl;
        };

        const renderMobileAgenda = (events) => {
          if (events.length === 0) return;

          const groupedEvents = events.reduce((acc, event) => {
            const dateKey = event.start.toDateString();
            if (!acc[dateKey]) acc[dateKey] = [];
            acc[dateKey].push(event);
            return acc;
          }, {});

          const sortedDates = Object.keys(groupedEvents).sort(
            (a, b) => new Date(a) - new Date(b)
          );

          sortedDates.forEach((dateStr) => {
            const date = new Date(dateStr);
            const dayHeader = document.createElement('div');
            dayHeader.className =
              'px-4 py-2 bg-gray-100 sticky top-24 border-y-2 border-black';
            dayHeader.innerHTML = `<h3 class="text-base font-bold uppercase">${formatDate(
              date,
              { weekday: 'long' }
            )} - ${formatDate(date, { month: 'long', day: 'numeric' })}</h3>`;
            DOMElements.agendaView.appendChild(dayHeader);

            groupedEvents[dateStr].forEach((event) => {
              const eventEl = document.createElement('div');
              eventEl.className = 'p-4 border-b-2 border-gray-200';
              eventEl.innerHTML = `
                <button class="w-full text-left focus:outline-none">
                  <h4 class="font-bold text-black uppercase">${event.title}</h4>
                  <p class="text-sm text-gray-600 mt-1">${event.location}</p>
                  <div class="flex flex-wrap items-center gap-2 mt-2">
                    <span class="px-2 py-0.5 text-xs font-bold uppercase rounded-md" style="background-color:${
                      event.color
                    }; color:${getTextColorForBg(event.color)}">${
                event.category
              }</span>
                    ${event.academic_years
                      .map(
                        (yr) =>
                          `<span class="text-xs bg-gray-200 text-gray-800 px-2 py-0.5 font-bold rounded-md">
                            ${
                              yr === 'FY'
                                ? 'First Year'
                                : yr === 'SY'
                                ? 'Second Year'
                                : yr === 'TY'
                                ? 'Third Year'
                                : yr === 'FR'
                                ? 'Fourth Year'
                                : ''
                            }
                          </span>`
                      )
                      .join('')}
                  </div>
                </button>
              `;
              eventEl.querySelector('button').onclick = () =>
                showEventModal(event);
              DOMElements.agendaView.appendChild(eventEl);
            });
          });
        };

        const showErrorState = (message) => {
          DOMElements.calendarStateOverlay.classList.remove('hidden');
          DOMElements.calendarStateOverlay.innerHTML = `
            <div class="text-red-600">
              <i class="ri-error-warning-line text-5xl mb-4"></i>
              <h3 class="text-2xl font-bold uppercase">ERROR</h3>
              <p class="text-gray-600 mt-2">${message}</p>
              <button id="retry-fetch" class="mt-6 btn btn-primary">Try Again</button>
            </div>`;
          document
            .getElementById('retry-fetch')
            .addEventListener('click', fetchAllEvents);
        };

        const showEmptyState = () => {
          DOMElements.noEventsContainer.classList.remove('hidden');
        };

        const showEventModal = (event) => {
          DOMElements.modalTitle.textContent = event.title;
          DOMElements.modalCategory.textContent = event.category;
          DOMElements.modalCategory.style.backgroundColor = event.color;
          DOMElements.modalCategory.className = `px-3 py-1 text-xs font-bold uppercase rounded-md ${getTextColorForBg(
            event.color
          )}`;
          DOMElements.modalAcademicYears.innerHTML = event.academic_years
            .map(
              (yr) =>
                `<span class="text-xs bg-gray-200 text-gray-800 px-2 py-0.5 font-bold rounded-md">
                  ${
                    yr === 'FY'
                      ? 'First Year'
                      : yr === 'SY'
                      ? 'Second Year'
                      : yr === 'TY'
                      ? 'Third Year'
                      : yr === 'FR'
                      ? 'Fourth Year'
                      : ''
                  }
                </span>`
            )
            .join('');
          const startDateStr = formatDate(event.start, {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          });
          const endDateStr = formatDate(event.end, {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          });
          DOMElements.modalDate.textContent =
            event.start.toDateString() === event.end.toDateString()
              ? startDateStr
              : `${startDateStr} - ${endDateStr}`;
          DOMElements.modalLocation.textContent =
            event.location || 'Not specified';
          DOMElements.modalDescription.innerHTML =
            event.description || 'No description provided.';
          DOMElements.eventModal.classList.remove('hidden');
          DOMElements.closeModalBtn.focus();
        };

        const hideEventModal = () => {
          DOMElements.eventModal.classList.add('hidden');
        };

        const changeMonth = (offset) => {
          const d = new Date(state.currentDate);
          d.setDate(1);
          d.setMonth(d.getMonth() + offset);
          state.currentDate = d;

          mobileCalendarState.selectedDayEl = null;

          applyFiltersAndRender();
        };

        const setupEventListeners = () => {
          DOMElements.prevMonthBtn.addEventListener('click', () =>
            changeMonth(-1)
          );
          DOMElements.nextMonthBtn.addEventListener('click', () =>
            changeMonth(1)
          );
          DOMElements.todayBtn.addEventListener('click', () => {
            state.currentDate = new Date();
            applyFiltersAndRender();
          });

          DOMElements.eventTypeFilter.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (btn) {
              state.filters.eventType = btn.dataset.type;
              applyFiltersAndRender();
            }
          });

          DOMElements.academicYearFilter.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (btn) {
              const year = btn.dataset.year;
              const newYears = state.filters.academicYears.includes(year)
                ? state.filters.academicYears.filter((y) => y !== year)
                : [...state.filters.academicYears, year];
              state.filters.academicYears = newYears;
              applyFiltersAndRender();
            }
          });

          DOMElements.clearFiltersBtn.addEventListener('click', () => {
            state.filters = { eventType: 'all', academicYears: [] };
            applyFiltersAndRender();
          });

          DOMElements.mobileFilterToggle.addEventListener('click', () =>
            DOMElements.filterSidebar.classList.remove('hidden')
          );
          DOMElements.closeFiltersBtn.addEventListener('click', () =>
            DOMElements.filterSidebar.classList.add('hidden')
          );

          DOMElements.closeModalBtn.addEventListener('click', hideEventModal);
          DOMElements.modalBackdrop.addEventListener('click', (e) => {
            if (e.target === DOMElements.modalBackdrop) hideEventModal();
          });
          document.addEventListener('keydown', (e) => {
            if (
              e.key === 'Escape' &&
              !DOMElements.eventModal.classList.contains('hidden')
            )
              hideEventModal();
          });
        };

        let mobileCalendarState = {
          selectedDayEl: null,
        };

        const renderMobileCalendar = () => {
          const calendarEl = DOMElements.mobileCalendar;
          calendarEl.innerHTML = '';
          if (state.isLoading) {
            calendarEl.innerHTML =
              '<div class="p-4 text-center">Loading...</div>';
            return;
          }
          if (state.error) {
            calendarEl.innerHTML = `<div class="p-4 text-center text-red-500">Error loading events.</div>`;
            return;
          }

          const momentDate = moment(state.currentDate);

          const header = document.createElement('div');
          header.className = 'header';
          const title = document.createElement('h1');
          title.textContent = momentDate.format('MMMM YYYY');
          const left = document.createElement('div');
          left.className = 'left';
          left.onclick = () => changeMonth(-1);
          const right = document.createElement('div');
          right.className = 'right';
          right.onclick = () => changeMonth(1);
          header.append(left, title, right);
          calendarEl.appendChild(header);

          const monthEl = document.createElement('div');
          monthEl.className = 'month';

          const firstDay = momentDate.clone().startOf('month');
          const lastDay = momentDate.clone().endOf('month');
          const startOfWeek = firstDay.clone().startOf('week');
          const endOfWeek = lastDay.clone().endOf('week');

          let currentDay = startOfWeek.clone();
          while (currentDay.isBefore(endOfWeek, 'day')) {
            const weekEl = document.createElement('div');
            weekEl.className = 'week';
            for (let i = 0; i < 7; i++) {
              const dayClasses = ['day'];
              if (!currentDay.isSame(momentDate, 'month'))
                dayClasses.push('other');
              if (currentDay.isSame(moment(), 'day')) dayClasses.push('today');

              const dayEl = document.createElement('div');
              dayEl.className = dayClasses.join(' ');
              dayEl.dataset.date = currentDay.format('YYYY-MM-DD');

              const dayName = document.createElement('div');
              dayName.className = 'day-name';
              dayName.textContent = currentDay.format('ddd');

              const dayNumber = document.createElement('div');
              dayNumber.className = 'day-number';
              dayNumber.textContent = currentDay.format('DD');

              const dayEvents = document.createElement('div');
              dayEvents.className = 'day-events';

              const eventsForDay = state.events.filter((ev) =>
                moment(ev.start).isSame(currentDay, 'day')
              );

              const uniqueColors = new Set(eventsForDay.map((ev) => ev.color));

              uniqueColors.forEach((color) => {
                const evSpan = document.createElement('span');
                evSpan.style.backgroundColor = color;
                dayEvents.appendChild(evSpan);
              });

              dayEl.append(dayName, dayNumber, dayEvents);
              dayEl.addEventListener('click', (e) =>
                openMobileDayDetails(e.currentTarget)
              );
              weekEl.appendChild(dayEl);
              currentDay.add(1, 'day');
            }
            monthEl.appendChild(weekEl);
          }
          calendarEl.appendChild(monthEl);
        };

        const openMobileDayDetails = (dayEl) => {
          const date = dayEl.dataset.date;
          const eventsForDay = state.events.filter((ev) =>
            moment(ev.start).isSame(date, 'day')
          );

          const weekElement = dayEl.parentNode;
          const existingDetails =
            DOMElements.mobileCalendar.querySelector('.details');

          if (mobileCalendarState.selectedDayEl === dayEl) {
            if (existingDetails) existingDetails.remove();
            mobileCalendarState.selectedDayEl = null;
            return;
          }

          let details;
          let arrow;

          if (
            existingDetails &&
            existingDetails.previousSibling === weekElement
          ) {
            details = existingDetails;
            arrow = details.querySelector('.arrow');
          } else {
            if (existingDetails) {
              existingDetails.remove();
            }
            details = document.createElement('div');
            details.className = 'details in';
            arrow = document.createElement('div');
            arrow.className = 'arrow';
            details.appendChild(arrow);
            weekElement.parentNode.insertBefore(
              details,
              weekElement.nextSibling
            );
          }

          mobileCalendarState.selectedDayEl = dayEl;

          const dayCenter =
            dayEl.offsetLeft - weekElement.offsetLeft + dayEl.offsetWidth / 2;
          arrow.style.left = dayCenter + 'px';

          const oldEventsWrapper = details.querySelector('.events');
          if (oldEventsWrapper) oldEventsWrapper.remove();

          const eventsWrapper = document.createElement('div');
          eventsWrapper.className = 'events in';

          if (eventsForDay.length > 0) {
            eventsForDay.forEach((ev) => {
              const div = document.createElement('div');
              div.className = 'event';
              div.style.cursor = 'pointer';
              div.onclick = (e) => {
                e.stopPropagation();
                showEventModal(ev);
              };

              const square = document.createElement('div');
              square.className = 'event-category';
              square.style.backgroundColor = ev.color;
              const span = document.createElement('span');
              span.textContent = ev.title;
              div.append(square, span);
              eventsWrapper.appendChild(div);
            });
          } else {
            const div = document.createElement('div');
            div.className = 'event empty';
            const span = document.createElement('span');
            span.textContent = 'No Events';
            div.appendChild(span);
            eventsWrapper.appendChild(div);
          }
          details.appendChild(eventsWrapper);
        };

        const init = () => {
          loadStateFromLocalStorage();
          setupEventListeners();
          fetchAllEvents();
        };

        init();
      });
    </script>
  </body>
</html>
