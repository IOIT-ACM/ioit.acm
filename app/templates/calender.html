<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>College Academic Calendar | AISSMS IOIT ACM Student Chapter</title>

    <!-- SEO Metadata -->
    <meta
      name="description"
      content="AISSMS IOIT ACM student chapter & College Academic Calendar - View upcoming ACM chapter events, college activities, academic calendar, exams, workshops, and more for IOIT students. Stay updated and never miss an important date!"
    />
    <meta
      name="keywords"
      content="AISSMS IOIT, ACM, Academic calendar, college events, academic calendar, exams, workshops, student activities, computing, technology, student chapter, Pune"
    />
    <meta name="author" content="AISSMS IOIT ACM Student Chapter" />
    <meta name="robots" content="index, follow" />
    <meta name="language" content="English" />
    <meta name="theme-color" content="#007BFF" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="IOIT ACM Calendar" />
    <meta name="mobile-web-app-capable" content="yes" />

    <!-- Open Graph (OG) Tags -->
    <meta property="og:type" content="website" />
    <meta
      property="og:title"
      content="ACM & College Academic Calendar | AISSMS IOIT"
    />
    <meta
      property="og:description"
      content="Discover all ACM and college events at AISSMS IOIT. Access the academic calendar, exam schedules, workshops, and student activities in one place."
    />
    <meta property="og:url" content="https://ioit.acm.org/calendar" />
    <meta property="og:image" content="/static/og-image.png" />
    <meta property="og:site_name" content="AISSMS IOIT ACM Calendar" />
    <meta property="og:locale" content="en_US" />

    <!-- Twitter Card Metadata -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content="ACM & College Academic Calendar | AISSMS IOIT"
    />
    <meta
      name="twitter:description"
      content="Stay updated with ACM and college events, academic calendar, exams, and workshops at AISSMS IOIT. All student activities in one calendar."
    />
    <meta name="twitter:image" content="/static/og-image.png" />
    <meta name="twitter:site" content="@AISSMSIOIT" />
    <meta name="twitter:creator" content="@AISSMSIOIT" />

    <!-- Favicon Configuration -->
    <link
      rel="icon"
      type="image/png"
      href="/static/favicon-96x96.png"
      sizes="96x96"
    />
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
    <link rel="shortcut icon" href="/static/favicon.ico" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/static/apple-touch-icon.png"
    />
    <link rel="manifest" href="/static/site.webmanifest" />

    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-Y6Z6G51Z27"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'G-Y6Z6G51Z27');
    </script>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/static/css/tailwind.css" />
    <link rel="stylesheet" href="/static/css/styles.css" />

    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <style>
      :root {
        --background: 0 0% 100%;
        --foreground: 0 0% 3.9%;
        --card: 0 0% 100%;
        --card-foreground: 0 0% 3.9%;
        --primary: 0 0% 9%;
        --primary-foreground: 0 0% 98%;
        --secondary: 0 0% 96.1%;
        --muted-foreground: 0 0% 45.1%;
        --border: 0 0% 89.8%;
        --ring: 0 0% 3.9%;
        --black: rgba(0, 0, 0, 1);
        --grey: rgb(83, 83, 83);
        --border-width-medium: 2px;
        --border-width-thick: 4px;
        --border-color-strong: var(--black);
        --radius-base: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-2xl: 1.5rem;
        --shadow-small: 4px 4px 0px 0px var(--black);
        --shadow-large: 8px 8px 0px 0px var(--black);
      }
      body {
        font-family: 'Arial', Helvetica, sans-serif;
        background-color: hsl(var(--background));
        color: hsl(var(--foreground));
        background-image: linear-gradient(to bottom right, #e9d5ff, #dbeafe);
      }
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-weight: 900;
        letter-spacing: -0.025em;
      }
      .glass-brutalist-container {
        background-color: rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(1.25rem);
        -webkit-backdrop-filter: blur(1.25rem);
        border: var(--border-width-thick) solid var(--border-color-strong);
        border-radius: var(--radius-2xl);
        box-shadow: var(--shadow-large);
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-lg);
        border: var(--border-width-medium) solid var(--border-color-strong);
        font-weight: 700;
        padding: 0.75rem 1.5rem;
        transition: all 0.15s ease-in-out;
        font-size: 0.875rem;
        line-height: 1.25rem;
        cursor: pointer;
      }
      .btn:active {
        transform: translate(4px, 4px);
        box-shadow: none !important;
      }
      .btn-primary {
        background-color: var(--grey);
        color: hsl(var(--primary-foreground));
        box-shadow: var(--shadow-small);
      }
      .btn-primary:hover {
        background-color: rgb(51 65 85);
      }
      .btn-outline {
        background-color: hsl(var(--card));
        color: hsl(var(--foreground));
        box-shadow: var(--shadow-small);
      }
      .btn-outline:hover {
        background-color: hsl(var(--secondary));
      }
      .tabs-trigger:hover {
        background-color: hsl(var(--secondary));
      }
      .btn-icon {
        padding: 0.75rem;
      }
      .card {
        border: var(--border-width-thick) solid var(--border-color-strong);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-large);
        overflow: hidden;
        background-color: hsl(var(--card));
      }
      .card-header {
        padding: 1rem;
        color: white;
      }
      .card-content {
        padding: 1.5rem;
        background-color: hsl(var(--card));
      }
      .tabs-list {
        display: flex;
        background-color: hsl(var(--secondary));
        border: var(--border-width-medium) solid var(--border-color-strong);
        border-radius: var(--radius-lg);
        padding: 0.45rem;
        gap: 0.5rem;
      }
      .tabs-trigger {
        flex: 1;
        padding: 0.5rem;
        border-radius: var(--radius-base);
        font-weight: 700;
        color: hsl(var(--muted-foreground));
        transition: all 0.2s ease-in-out;
        border: 2px solid transparent;
      }
      .tabs-trigger[aria-checked='true'] {
        background-color: var(--grey);
        color: hsl(var(--primary-foreground));
        box-shadow: var(--shadow-small);
      }
      .tabs-trigger:not([aria-checked='true']):hover {
        background-color: white;
        border-color: var(--black);
      }
      .bg-gradient-video {
        background-image: linear-gradient(to bottom right, #3b82f6, #8b5cf6);
      }
      *::-webkit-scrollbar {
        display: none;
      }
      * {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <header
      class="sticky top-0 z-30 border-b-4 border-black bg-white/50 backdrop-blur-md"
    >
      <div
        class="max-w-screen-[1500px] mx-auto px-4 sm:px-6 lg:px-8"
        aria-label="Primary navigation"
      >
        <div class="flex justify-between items-center h-16 md:h-24">
          <div class="flex items-center space-x-4">
            <i class="ri-calendar-event-fill text-4xl text-black"></i>
            <h1 class="md:text-3xl uppercase tracking-tight">
              Annual Calender
            </h1>
          </div>
          <div class="hidden md:flex items-center space-x-4">
            <button id="today-btn" class="btn btn-primary">Today</button>
            <div
              class="flex items-center border-2 border-black rounded-xl overflow-hidden shadow-sm"
            >
              <button
                id="prev-month"
                aria-label="Previous month"
                class="p-3 bg-white hover:bg-gray-200 transition-colors"
              >
                <i class="ri-arrow-left-s-line text-2xl"></i>
              </button>
              <span
                id="current-month"
                class="text-lg font-bold uppercase px-6 py-3 w-56 text-center bg-white border-x-2 border-black"
                aria-live="polite"
              >
              </span>
              <button
                id="next-month"
                aria-label="Next month"
                class="p-3 bg-white hover:bg-gray-200 transition-colors"
              >
                <i class="ri-arrow-right-s-line text-2xl"></i>
              </button>
            </div>
          </div>
          <div class="md:hidden">
            <button
              id="mobile-filter-toggle"
              aria-label="Open filters"
              class="p-2 text-black"
            >
              <i class="ri-filter-3-line text-3xl"></i>
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-screen-[1500px] mx-auto md:p-4">
      <div class="p-4">
        <div class="lg:grid lg:grid-cols-12 lg:gap-8">
          <aside
            id="filter-sidebar"
            class="fixed inset-0 bg-black/50 z-40 lg:z-auto lg:static lg:bg-transparent lg:block lg:col-span-3 hidden"
          >
            <div class="card bg-white w-80 lg:w-auto p-6 lg:sticky lg:top-32">
              <div class="flex justify-between items-center lg:hidden mb-6">
                <h2 class="text-2xl uppercase">Filters</h2>
                <button id="close-filters" aria-label="Close filters">
                  <i class="ri-close-line text-3xl text-black"></i>
                </button>
              </div>
              <div class="space-y-8">
                <div>
                  <label class="text-sm font-bold text-black uppercase"
                    >Event Type</label
                  >
                  <div
                    id="event-type-filter"
                    class="tabs-list mt-2"
                    role="radiogroup"
                  >
                    <button
                      role="radio"
                      aria-checked="true"
                      data-type="all"
                      class="tabs-trigger"
                    >
                      All
                    </button>
                    <button
                      role="radio"
                      aria-checked="false"
                      data-type="acm"
                      class="tabs-trigger"
                    >
                      ACM
                    </button>
                    <button
                      role="radio"
                      aria-checked="false"
                      data-type="non-acm"
                      class="tabs-trigger"
                    >
                      College
                    </button>
                  </div>
                </div>

                <div>
                  <label class="text-sm font-bold text-black uppercase"
                    >Academic Year</label
                  >
                  <div
                    id="academic-year-filter"
                    class="grid grid-cols-1 gap-3 mt-2"
                  >
                    <button data-year="FY" class="btn btn-outline w-full">
                      First Year
                    </button>
                    <button data-year="SY" class="btn btn-outline w-full">
                      Second Year
                    </button>
                    <button data-year="TY" class="btn btn-outline w-full">
                      Third year
                    </button>
                    <button data-year="FR" class="btn btn-outline w-full">
                      Fourth Year
                    </button>
                  </div>
                </div>

                <div
                  class="flex items-center justify-between pt-6 border-t-2 border-gray-200"
                >
                  <span
                    id="filter-count"
                    class="text-sm text-gray-500 font-bold"
                  ></span>
                  <button
                    id="clear-filters"
                    class="text-sm font-bold text-black hover:underline uppercase"
                  >
                    Clear All
                  </button>
                </div>
              </div>
            </div>
          </aside>

          <div class="lg:col-span-9 mt-8 lg:mt-0">
            <div class="card bg-white">
              <div
                class="grid grid-cols-7 bg-white border-b-4 border-black"
                role="row"
              >
                <div
                  class="p-3 text-center font-bold text-black uppercase"
                  role="columnheader"
                >
                  Sun
                </div>
                <div
                  class="p-3 text-center font-bold text-black uppercase"
                  role="columnheader"
                >
                  Mon
                </div>
                <div
                  class="p-3 text-center font-bold text-black uppercase"
                  role="columnheader"
                >
                  Tue
                </div>
                <div
                  class="p-3 text-center font-bold text-black uppercase"
                  role="columnheader"
                >
                  Wed
                </div>
                <div
                  class="p-3 text-center font-bold text-black uppercase"
                  role="columnheader"
                >
                  Thu
                </div>
                <div
                  class="p-3 text-center font-bold text-black uppercase"
                  role="columnheader"
                >
                  Fri
                </div>
                <div
                  class="p-3 text-center font-bold text-black uppercase"
                  role="columnheader"
                >
                  Sat
                </div>
              </div>

              <div class="relative">
                <div
                  id="calendar-body"
                  class="grid grid-cols-7 md:grid"
                  role="grid"
                ></div>

                <div id="agenda-view"></div>

                <div
                  id="calendar-state-overlay"
                  class="absolute hidden inset-0 z-10 bg-white/80 backdrop-blur-sm p-8 text-center min-h-[50vh] flex items-center justify-center"
                  aria-live="polite"
                ></div>
              </div>

              <div id="no-events-container" class="hidden"></div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div
      id="event-modal"
      class="fixed inset-0 bg-black/80 hidden z-50"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modal-title"
    >
      <div
        class="flex items-center justify-center min-h-screen p-4"
        id="modal-backdrop"
      >
        <div
          class="card max-w-2xl w-full max-h-[90vh] flex flex-col"
          id="modal-panel"
        >
          <div
            class="card-header bg-gradient-video flex justify-between items-start border-b-4 border-black"
          >
            <h2 id="modal-title" class="text-3xl uppercase"></h2>
            <button
              id="close-modal"
              class="text-white hover:opacity-75"
              aria-label="Close event details"
            >
              <i class="ri-close-line text-3xl"></i>
            </button>
          </div>

          <div class="card-content space-y-6 overflow-y-auto no-scrollbar">
            <div class="flex flex-wrap items-center gap-x-4 gap-y-2">
              <span
                id="modal-category"
                class="px-3 py-1 text-xs font-bold uppercase rounded-md"
              ></span>
              <div id="modal-academic-years" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="flex items-start space-x-4 text-black">
              <i class="ri-calendar-event-line text-2xl mt-1"></i>
              <span id="modal-date" class="text-base font-bold"></span>
            </div>

            <div class="flex items-start space-x-4 text-black">
              <i class="ri-map-pin-line text-2xl mt-1"></i>
              <span id="modal-location" class="text-base font-bold"></span>
            </div>

            <div>
              <h3 class="text-lg uppercase mb-2">Description</h3>
              <div
                id="modal-description"
                class="text-gray-700 max-w-none"
              ></div>
            </div>
          </div>
          <div
            class="p-4 bg-white border-t-4 border-black flex justify-end space-x-3"
          >
            <button id="share-event-btn" class="btn btn-outline">
              <i class="ri-share-line mr-2"></i>Share
            </button>
            <button id="add-to-calendar-btn" class="btn btn-primary">
              <i class="ri-add-line mr-2"></i>Add to Calendar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const API_URL = 'http://localhost:8000/events/api/events/filter/';
        const LOCAL_STORAGE_KEY = 'collegeCalendarState';

        const DOMElements = {
          prevMonthBtn: document.getElementById('prev-month'),
          nextMonthBtn: document.getElementById('next-month'),
          todayBtn: document.getElementById('today-btn'),
          currentMonthEl: document.getElementById('current-month'),
          calendarBody: document.getElementById('calendar-body'),
          AgendaView: document.getElementById('agenda-view'),
          calendarStateOverlay: document.getElementById(
            'calendar-state-overlay'
          ),
          noEventsContainer: document.getElementById('no-events-container'),
          filterSidebar: document.getElementById('filter-sidebar'),
          mobileFilterToggle: document.getElementById('mobile-filter-toggle'),
          closeFiltersBtn: document.getElementById('close-filters'),
          eventTypeFilter: document.getElementById('event-type-filter'),
          academicYearFilter: document.getElementById('academic-year-filter'),
          filterCountEl: document.getElementById('filter-count'),
          clearFiltersBtn: document.getElementById('clear-filters'),
          eventModal: document.getElementById('event-modal'),
          modalBackdrop: document.getElementById('modal-backdrop'),
          closeModalBtn: document.getElementById('close-modal'),
          modalTitle: document.getElementById('modal-title'),
          modalCategory: document.getElementById('modal-category'),
          modalAcademicYears: document.getElementById('modal-academic-years'),
          modalDate: document.getElementById('modal-date'),
          modalLocation: document.getElementById('modal-location'),
          modalDescription: document.getElementById('modal-description'),
        };

        let state = {
          currentDate: new Date(),
          filters: { eventType: 'all', academicYears: [] },
          events: [],
          isLoading: true,
          error: null,
        };
        const apiCache = new Map();
        const setState = (newState) => {
          state = { ...state, ...newState };
          render();
          saveStateToLocalStorage();
        };
        const setFilters = (newFilters) => {
          const updatedFilters = { ...state.filters, ...newFilters };
          setState({ filters: updatedFilters, isLoading: true });
          fetchEvents();
        };

        const saveStateToLocalStorage = () => {
          try {
            const stateToSave = { filters: state.filters };
            localStorage.setItem(
              LOCAL_STORAGE_KEY,
              JSON.stringify(stateToSave)
            );
          } catch (e) {
            console.error('Could not save state to localStorage', e);
          }
        };
        const loadStateFromLocalStorage = () => {
          try {
            const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedState) {
              const parsed = JSON.parse(savedState);
              state.filters = parsed.filters || {
                eventType: 'all',
                academicYears: [],
              };
            }
          } catch (e) {
            console.error('Could not load state from localStorage', e);
            localStorage.removeItem(LOCAL_STORAGE_KEY);
          }
        };

        const fetchEvents = async () => {
          const year = state.currentDate.getFullYear();
          const month = state.currentDate.getMonth();
          const startDate = new Date(year, month, 1);
          const endDate = new Date(year, month + 1, 0);
          const formatDateForAPI = (date) => date.toISOString().split('T')[0];
          const requestBody = {
            start_date: formatDateForAPI(startDate),
            end_date: formatDateForAPI(endDate),
          };
          if (state.filters.academicYears.length > 0)
            requestBody.academic_years = state.filters.academicYears;

          const categoriesToFilter = new Set();
          if (
            state.filters.eventType === 'acm' ||
            state.filters.eventType === 'non-acm'
          ) {
            categoriesToFilter.add(state.filters.eventType);
          }
          if (categoriesToFilter.size > 0) {
            requestBody.categories = Array.from(categoriesToFilter);
          }

          const cacheKey = JSON.stringify(requestBody);
          if (apiCache.has(cacheKey)) {
            processApiData(apiCache.get(cacheKey));
            return;
          }
          try {
            setState({ ...state, isLoading: true });
            const response = await fetch(API_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(requestBody),
            });
            if (!response.ok) {
              let errorMessage = `API Error: ${response.status} ${response.statusText}`;
              try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorMessage;
              } catch (e) {}
              throw new Error(errorMessage);
            }
            const data = await response.json();
            apiCache.set(cacheKey, data);
            processApiData(data);
          } catch (error) {
            console.error('Failed to fetch events:', error);
            setState({ error: error.message, isLoading: false, events: [] });
          }
        };

        const processApiData = (data) => {
          const events = data.map((event) => {
            const start = new Date(event.start_date + 'T00:00:00');
            const end = event.end_date
              ? new Date(event.end_date + 'T00:00:00')
              : new Date(start.getTime());
            return { ...event, start, end };
          });
          setState({ events, isLoading: false, error: null });
        };

        const getTextColorForBg = (hexColor) => {
          if (!hexColor || hexColor.length < 7) return 'text-black';
          const r = parseInt(hexColor.substr(1, 2), 16);
          const g = parseInt(hexColor.substr(3, 2), 16);
          const b = parseInt(hexColor.substr(5, 2), 16);
          const yiq = (r * 299 + g * 587 + b * 114) / 1000;
          return yiq >= 128 ? 'text-black' : 'text-white';
        };

        const formatDate = (date, options) =>
          date.toLocaleDateString('en-US', options);

        const render = () => {
          renderHeader();
          renderFilters();
          renderCalendar();
        };

        const renderHeader = () => {
          DOMElements.currentMonthEl.textContent = formatDate(
            state.currentDate,
            { month: 'long', year: 'numeric' }
          );
        };

        const renderFilters = () => {
          DOMElements.eventTypeFilter
            .querySelectorAll('button')
            .forEach((btn) => {
              btn.setAttribute(
                'aria-checked',
                state.filters.eventType === btn.dataset.type
              );
            });

          DOMElements.academicYearFilter
            .querySelectorAll('button')
            .forEach((btn) => {
              const isActive = state.filters.academicYears.includes(
                btn.dataset.year
              );
              btn.classList.toggle('btn-primary', isActive);
              btn.classList.toggle('btn-outline', !isActive);
            });

          const count =
            (state.filters.eventType !== 'all' ? 1 : 0) +
            state.filters.academicYears.length;
          DOMElements.filterCountEl.textContent =
            count > 0
              ? `${count} FILTER${count > 1 ? 'S' : ''} ON`
              : 'No filters';
          DOMElements.clearFiltersBtn.style.display =
            count > 0 ? 'block' : 'none';
        };

        const renderCalendar = () => {
          DOMElements.calendarStateOverlay.classList.add('hidden');
          DOMElements.noEventsContainer.classList.add('hidden');
          DOMElements.noEventsContainer.innerHTML = '';

          if (state.isLoading) {
            renderSkeletonCalendar();
            DOMElements.AgendaView.innerHTML = '';
          } else if (state.error) {
            renderDesktopCalendar([]);
            DOMElements.AgendaView.innerHTML = '';
            showErrorState(state.error);
          } else {
            renderDesktopCalendar(state.events);
            renderMobileAgenda(state.events);

            if (state.events.length === 0) {
              showEmptyState();
            }
          }
        };

        const renderSkeletonCalendar = () => {
          const year = state.currentDate.getFullYear();
          const month = state.currentDate.getMonth();
          const firstDayOfMonth = new Date(year, month, 1);
          const lastDayOfMonth = new Date(year, month + 1, 0);
          const firstDayOfWeek = firstDayOfMonth.getDay();

          DOMElements.calendarBody.innerHTML = '';

          for (let i = 0; i < firstDayOfWeek; i++) {
            DOMElements.calendarBody.innerHTML +=
              '<div class="border-r border-b border-gray-200 bg-gray-50 min-h-[9rem]"></div>';
          }

          for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
            const date = new Date(year, month, day);
            const dayEl = document.createElement('div');
            dayEl.className =
              'min-h-[9rem] relative p-1 border-r border-b border-gray-200 flex flex-col';

            const dayNumber = document.createElement('span');
            dayNumber.textContent = day;
            dayNumber.className =
              'text-sm font-bold text-gray-500 w-7 h-7 flex items-center justify-center rounded-full';

            if (date.toDateString() === new Date().toDateString()) {
              dayNumber.className =
                'bg-black text-white w-7 h-7 flex items-center justify-center font-bold rounded-full';
            }
            dayEl.appendChild(dayNumber);

            const eventsWrapper = document.createElement('div');
            eventsWrapper.className =
              'mt-1 flex-grow overflow-hidden space-y-2 p-1';
            eventsWrapper.innerHTML = `
                <div class="h-5 bg-gray-200 rounded animate-pulse"></div>
                <div class="h-5 bg-gray-200 rounded animate-pulse w-2/3"></div>
            `;
            dayEl.appendChild(eventsWrapper);
            DOMElements.calendarBody.appendChild(dayEl);
          }
        };

        const renderDesktopCalendar = (events) => {
          const year = state.currentDate.getFullYear();
          const month = state.currentDate.getMonth();
          const firstDayOfMonth = new Date(year, month, 1);
          const lastDayOfMonth = new Date(year, month + 1, 0);
          const firstDayOfWeek = firstDayOfMonth.getDay();

          DOMElements.calendarBody.innerHTML = '';

          for (let i = 0; i < firstDayOfWeek; i++) {
            DOMElements.calendarBody.innerHTML +=
              '<div class="border-r border-b border-gray-200 bg-gray-50 min-h-[9rem]"></div>';
          }

          const dayCells = [];

          for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
            const date = new Date(year, month, day);
            const dayEl = document.createElement('div');
            dayEl.className =
              'min-h-[9rem] relative p-1 border-r border-b border-gray-200 flex flex-col';
            dayEl.setAttribute('role', 'gridcell');
            dayEl.setAttribute(
              'aria-label',
              formatDate(date, {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
              })
            );

            const dayNumber = document.createElement('span');
            dayNumber.textContent = day;
            dayNumber.className =
              'text-sm font-bold text-gray-500 w-7 h-7 flex items-center justify-center rounded-full';

            if (date.toDateString() === new Date().toDateString()) {
              dayNumber.className =
                'bg-black text-white w-7 h-7 flex items-center justify-center font-bold rounded-full';
            }

            dayEl.appendChild(dayNumber);

            const eventsWrapper = document.createElement('div');
            eventsWrapper.className =
              'mt-1 flex-grow overflow-y-auto no-scrollbar space-y-1';
            dayEl.appendChild(eventsWrapper);

            DOMElements.calendarBody.appendChild(dayEl);

            dayCells[day - 1] = dayEl;
          }

          events.forEach((event) => {
            const startDate = new Date(event.start);
            const endDate = new Date(event.end);

            const currentDate = new Date(startDate);

            while (currentDate <= endDate) {
              if (currentDate.getMonth() === month) {
                const dayNumber = currentDate.getDate();
                const dayCell = dayCells[dayNumber - 1];
                if (dayCell) {
                  const eventEl = createEventElement(event);
                  dayCell.querySelector('.flex-grow').appendChild(eventEl);
                }
              }
              currentDate.setDate(currentDate.getDate() + 1);
            }
          });
        };

        const createEventElement = (event) => {
          const eventEl = document.createElement('button');
          eventEl.className = `w-full text-left p-1.5 text-xs font-bold uppercase rounded-md border-2 border-transparent hover:border-black transition-colors`;
          eventEl.style.backgroundColor = event.color;
          eventEl.classList.add(getTextColorForBg(event.color));
          eventEl.textContent = event.title;
          eventEl.setAttribute(
            'aria-label',
            `${event.title}, ${formatDate(event.start, {
              month: 'short',
              day: 'numeric',
            })}`
          );
          eventEl.onclick = () => showEventModal(event);
          return eventEl;
        };

        const renderMobileAgenda = (events) => {
          DOMElements.AgendaView.innerHTML = '';
          if (events.length === 0) return;
          const groupedEvents = events.reduce((acc, event) => {
            const dateKey = event.start.toDateString();
            if (!acc[dateKey]) acc[dateKey] = [];
            acc[dateKey].push(event);
            return acc;
          }, {});
          const sortedDates = Object.keys(groupedEvents).sort(
            (a, b) => new Date(a) - new Date(b)
          );
          sortedDates.forEach((dateStr) => {
            const date = new Date(dateStr);
            const dayHeader = document.createElement('div');
            dayHeader.className =
              'px-4 py-2 bg-gray-100 sticky top-24 border-y-2 border-black';
            dayHeader.innerHTML = `<h3 class="text-base font-bold uppercase">${formatDate(
              date,
              { weekday: 'long' }
            )} - ${formatDate(date, { month: 'long', day: 'numeric' })}</h3>`;
            DOMElements.AgendaView.appendChild(dayHeader);
            groupedEvents[dateStr].forEach((event) => {
              const eventEl = document.createElement('div');
              eventEl.className = 'p-4 border-b-2 border-gray-200';
              eventEl.innerHTML = `
            <button class="w-full text-left focus:outline-none">
              <h4 class="font-bold text-black uppercase">${event.title}</h4>
              <p class="text-sm text-gray-600 mt-1">${event.location}</p>
              <div class="flex items-center space-x-2 mt-2">
                <span class="px-2 py-0.5 text-xs font-bold uppercase rounded-md" style="background-color:${
                  event.color
                }; color:${getTextColorForBg(event.color)}">${
                event.category
              }</span>
                ${event.academic_years
                  .map(
                    (yr) =>
                      `<span class="text-xs bg-gray-200 text-gray-800 px-2 py-0.5 font-bold rounded-md">
                        ${
                          yr === 'FY'
                            ? 'First Year'
                            : yr === 'SY'
                            ? 'Second Year'
                            : yr === 'TY'
                            ? 'Third Year'
                            : yr === 'FR'
                            ? 'Fourth Year'
                            : ''
                        }
                      </span>`
                  )
                  .join('')}
              </div>
            </button>
          `;
              eventEl.querySelector('button').onclick = () =>
                showEventModal(event);
              DOMElements.AgendaView.appendChild(eventEl);
            });
          });
        };

        const showErrorState = (message) => {
          DOMElements.calendarStateOverlay.classList.remove('hidden');
          DOMElements.calendarStateOverlay.innerHTML = `
        <div class="text-red-600">
          <i class="ri-error-warning-line text-5xl mb-4"></i>
          <h3 class="text-2xl font-bold uppercase">ERROR</h3>
          <p class="text-gray-600 mt-2">${message}</p>
          <button id="retry-fetch" class="mt-6 btn btn-primary">Try Again</button>
        </div>`;
          document
            .getElementById('retry-fetch')
            .addEventListener('click', fetchEvents);
        };

        const showEmptyState = () => {
          const noEventsHTML = `
            <div class="text-center p-8 border-t-4 border-black text-gray-500">
                <i class="ri-inbox-2-line text-5xl mb-4"></i>
                <h3 class="text-2xl font-bold uppercase">No Events Found</h3>
                <p class="mt-2">Try adjusting the filters or changing the month.</p>
            </div>`;
          DOMElements.noEventsContainer.innerHTML = noEventsHTML;
          DOMElements.noEventsContainer.classList.remove('hidden');
        };

        const showEventModal = (event) => {
          DOMElements.modalTitle.textContent = event.title;
          DOMElements.modalCategory.textContent = event.category;
          DOMElements.modalCategory.style.backgroundColor = event.color;
          DOMElements.modalCategory.className = `px-3 py-1 text-xs font-bold uppercase rounded-md ${getTextColorForBg(
            event.color
          )}`;
          DOMElements.modalAcademicYears.innerHTML = event.academic_years
            .map(
              (yr) =>
                `<span class="text-xs bg-gray-200 text-gray-800 px-2 py-0.5 font-bold rounded-md">
                  ${
                    yr === 'FY'
                      ? 'First Year'
                      : yr === 'SY'
                      ? 'Second Year'
                      : yr === 'TY'
                      ? 'Third Year'
                      : yr === 'FR'
                      ? 'Fourth Year'
                      : ''
                  }
                </span>`
            )
            .join('');
          const startDateStr = formatDate(event.start, {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          });
          const endDateStr = formatDate(event.end, {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          });
          DOMElements.modalDate.textContent =
            event.start.toDateString() === event.end.toDateString()
              ? startDateStr
              : `${startDateStr} - ${endDateStr}`;
          DOMElements.modalLocation.textContent =
            event.location || 'Not specified';
          DOMElements.modalDescription.innerHTML =
            event.description || 'No description provided.';
          DOMElements.eventModal.classList.remove('hidden');
          DOMElements.closeModalBtn.focus();
        };
        const hideEventModal = () => {
          DOMElements.eventModal.classList.add('hidden');
        };

        const setupEventListeners = () => {
          const changeMonth = (offset) => {
            const d = new Date(state.currentDate);
            d.setMonth(d.getMonth() + offset);
            setState({ currentDate: d });
            fetchEvents();
          };
          DOMElements.prevMonthBtn.addEventListener('click', () =>
            changeMonth(-1)
          );
          DOMElements.nextMonthBtn.addEventListener('click', () =>
            changeMonth(1)
          );
          DOMElements.todayBtn.addEventListener('click', () => {
            setState({ currentDate: new Date() });
            fetchEvents();
          });

          DOMElements.eventTypeFilter.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (btn) setFilters({ eventType: btn.dataset.type });
          });

          DOMElements.academicYearFilter.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (btn) {
              const year = btn.dataset.year;
              const newYears = state.filters.academicYears.includes(year)
                ? state.filters.academicYears.filter((y) => y !== year)
                : [...state.filters.academicYears, year];
              setFilters({ academicYears: newYears });
            }
          });

          DOMElements.clearFiltersBtn.addEventListener('click', () => {
            setFilters({ eventType: 'all', academicYears: [] });
          });

          DOMElements.mobileFilterToggle.addEventListener('click', () =>
            DOMElements.filterSidebar.classList.remove('hidden')
          );
          DOMElements.closeFiltersBtn.addEventListener('click', () =>
            DOMElements.filterSidebar.classList.add('hidden')
          );

          DOMElements.closeModalBtn.addEventListener('click', hideEventModal);
          DOMElements.modalBackdrop.addEventListener('click', (e) => {
            if (e.target === DOMElements.modalBackdrop) hideEventModal();
          });
          document.addEventListener('keydown', (e) => {
            if (
              e.key === 'Escape' &&
              !DOMElements.eventModal.classList.contains('hidden')
            )
              hideEventModal();
          });
        };

        const init = () => {
          loadStateFromLocalStorage();
          setupEventListeners();
          fetchEvents();
        };
        init();
      });
    </script>
  </body>
</html>
