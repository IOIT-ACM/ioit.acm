{% extends "base.html" %}
{% block title %}ACM Recruitment Form{% endblock %}
{% block content %}

<div class="flex justify-center bg-gray-100 px-4 sm:px-6">
    <div class="w-full max-w-6xl mx-auto">
        <h3 class="text-2xl font-bold text-center md:my-20 my-20 text-gray-800">
            ACM Recruitment Form
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Left Image -->
            <div class="w-full flex justify-center mt-10 md:mt-0">
                <div class="w-2/3 md:w-1/2 lg:w-2/5 md:mt-20 h-fit sticky top-32 mb-20">
                    <div
                        class="aspect-square bg-blue-500 w-1/2 h-auto transform absolute border border-white rounded-xl animate-rotate">
                    </div>
                    <div
                        class="aspect-square overflow-hidden bg-white w-full h-auto transform rotate-45 rounded-3xl border-4 border-white shadow-lg shadow-blue-400">
                        <img class="-rotate-45 z-50" src="{{ url_for('static', filename='og-image.png') }}"
                            alt="about-image" />
                    </div>
                </div>
            </div>

            <!-- Form -->
            <form id="acmForm" class="p-5 md:p-0 space-y-6">
                <!-- Step 1 -->
                <div id="step-1" class="form-step">
                    <p class="text-lg font-semibold text-gray-700 mb-6">Step 1: General Info</p>

                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">Full Name</label>
                        <input type="text" name="fullName" placeholder="Enter full name"
                            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">Branch</label>
                        <div class="space-y-1">
                            {% for b in ['CS', 'IT', 'AIDS', 'ENTC', 'ELEC', 'INSTRU'] %}
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="branch" value="{{ b }}" class="accent-blue-500" />
                                <span>{{ b }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">Year</label>
                        <div class="space-y-1">
                            {% for y in ['FY', 'SY', 'TY','BE'] %}
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="year" value="{{ y }}" class="accent-blue-500" />
                                <span>{{ y }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-2">Mobile Number</label>
                        <input type="tel" name="mobile" placeholder="Enter mobile number"
                            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>

                    <button type="button" onclick="if (validateStep(1)) nextStep();"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition">Next</button>
                </div>

                <!-- Step 2 -->
                <div id="step-2" class="form-step hidden">
                    <p class="text-lg font-semibold text-gray-700 mb-6">Step 2: Choose Your Role</p>

                    <div class="space-y-2 mb-6">
                        {% for role in ['chief', 'domainhead', 'mun', 'volunteer'] %}
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="roleType" value="{{ role }}" onchange="renderStage3()"
                                class="accent-blue-500" />
                            <span class="capitalize">{{ role.replace('head', ' Head') }}</span>
                        </label>
                        {% endfor %}
                    </div>

                    <div class="flex justify-between">
                        <button type="button" onclick="prevStep()"
                            class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded-lg transition">Back</button>
                        <button type="button" onclick="if (validateStep(2)) nextStep();"
                            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition">Next</button>
                    </div>
                </div>

                <!-- Step 3 -->
                <div id="step-3" class="form-step hidden space-y-6">
                    <!-- Chief -->
                    <div id="chief-fields" class="role-section hidden">
                        <label class="block text-gray-700 font-semibold mb-2">Chief Role</label>
                        <select name="chiefRole"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 mb-4">
                            <option value="" disabled selected>Select Chief Officer Role</option>
                            {% for c in
                            ['CEO','COO','CEMO','CSO','CMO','CTO','CFCO','CHO','CCO','CDO','CVLO','CAPO','CPRO','CFO','CMDO','CPO']
                            %}
                            <option value="{{ c }}">{{ c }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Domain Head -->
                    <div id="domainhead-fields" class="role-section hidden">
                        <label class="block text-gray-700 font-semibold mb-2">Domain</label>
                        <div class="space-y-1">
                            {% for domain in ['Techfiesta', 'Esummit', 'MUN', 'Esports'] %}
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="domainRole" value="{{ domain }} Domain Head"
                                    class="accent-blue-500" />
                                <span>{{ domain }} Domain Head</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- MUN -->
                    <div id="mun-fields" class="role-section hidden">
                        <label class="block text-gray-700 font-semibold mb-2">MUN Role</label>
                        <select name="munRole"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 mb-4">
                            <option value="" disabled selected>Select MUN Role</option>
                            {% for m in ['Secretary General','Deputy Secretary General','USG Management','USG Delegate
                            Affairs','USG Fin','USG Tech','USG Glob. Comm'] %}
                            <option value="{{ m }}">{{ m }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Volunteer -->
                    <div id="volunteer-fields" class="role-section hidden">
                        <label class="block text-gray-700 font-semibold mb-2">Interested Area</label>
                        <input name="volunteerArea" type="text" placeholder="e.g. Tech, Design, Events"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
                    </div>

                    <!-- Common -->
                    <div class="space-y-4">
                        <label class="block text-gray-700 font-semibold mb-2">Previous Experience (if any)</label>
                        <textarea name="experience" rows="3"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        <label class="block text-gray-700 font-semibold mb-2">Why this role?</label>
                        <textarea name="whyApply" rows="3"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <div class="flex justify-between pt-4">
                        <button type="button" onclick="prevStep()"
                            class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded-lg transition">Back</button>
                        <button type="submit"
                            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition">Submit</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let currentStep = 1;

    function goToStep(step) {
        document.querySelectorAll('.form-step').forEach(div => div.classList.add('hidden'));
        document.getElementById(`step-${step}`).classList.remove('hidden');
        currentStep = step;
    }

    function nextStep() {
        if (currentStep < 3) goToStep(currentStep + 1);
    }

    function prevStep() {
        if (currentStep > 1) goToStep(currentStep - 1);
    }

    function renderStage3() {
        const selected = document.querySelector('input[name="roleType"]:checked');
        document.querySelectorAll('.role-section').forEach(section => {
            section.classList.add('hidden');
            section.querySelectorAll('input, select').forEach(el => el.disabled = true);
        });
        if (selected) {
            const visible = document.getElementById(`${selected.value}-fields`);
            if (visible) {
                visible.classList.remove('hidden');
                visible.querySelectorAll('input, select').forEach(el => el.disabled = false);
            }
        }
    }

    function validateStep(stepNum) {
        const step = document.getElementById(`step-${stepNum}`);
        const inputs = step.querySelectorAll("input:not([disabled]), select:not([disabled]), textarea");
        let isValid = true, firstInvalid = null;

        inputs.forEach(input => {
            const wrapper = input.closest("div") || input.parentElement;
            input.classList.remove("border-red-500");
            const error = wrapper.querySelector(".error-msg");
            if (error) error.remove();
        });

        const form = document.getElementById("acmForm");
        const formData = new FormData(form);
        const roleType = formData.get("roleType");

        const always = ["fullName", "branch", "year", "mobile", "roleType", "whyApply"];
        const conditional = {
            chief: ["chiefRole"],
            domainhead: ["domainRole"],
            mun: ["munRole"],
            volunteer: ["volunteerArea"]
        };

        let fields = [];
        if (stepNum === 1) {
            fields = always.slice(0, 4);
        } else if (stepNum === 2) {
            fields = [always[4]];
        } else if (stepNum === 3) {
            fields = [always[5]]; // only whyApply is required
            if (conditional[roleType]) {
                fields = fields.concat(conditional[roleType]);
            }
        }

        for (const name of fields) {
            const els = step.querySelectorAll(`[name="${name}"]:not([disabled])`);
            let valid = false;

            if (els.length === 0) continue;

            if (els[0]?.type === "radio") {
                valid = [...els].some(e => e.checked);
            } else {
                valid = els[0] && els[0].value.trim() !== "";
            }

            if (!valid) {
                isValid = false;
                els.forEach(el => {
                    el.classList.add("border-red-500");
                    const wrapper = el.closest("div") || el.parentElement;
                    if (!wrapper.querySelector(".error-msg")) {
                        const msg = document.createElement("p");
                        msg.className = "text-sm text-red-500 mt-1 error-msg";
                        msg.innerText = "This field is required";
                        wrapper.appendChild(msg);
                    }
                });
                if (!firstInvalid) firstInvalid = els[0];
            }
        }

        if (!isValid && firstInvalid) firstInvalid.scrollIntoView({ behavior: 'smooth' });

        return isValid;
    }

    document.addEventListener("DOMContentLoaded", () => {
        goToStep(1);
        renderStage3();

        document.querySelectorAll('input, select, textarea').forEach(el => {
            el.addEventListener("input", () => {
                el.classList.remove("border-red-500");
                const err = el.closest("div")?.querySelector(".error-msg");
                if (err) err.remove();
            });
        });

        document.getElementById('acmForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            if (!validateStep(3)) return;

            const form = e.target;
            const formData = new FormData(form);
            const data = {};

            const roleType = formData.get("roleType");
            const alwaysInclude = ["fullName", "branch", "year", "mobile", "roleType", "whyApply", "experience"];
            const roleFields = {
                "chief": ["chiefRole"],
                "domainhead": ["domainRole"],
                "mun": ["munRole"],
                "volunteer": ["volunteerArea"]
            };

            formData.forEach((value, key) => {
                if (alwaysInclude.includes(key) || (roleFields[roleType] || []).includes(key)) {
                    data[key] = value;
                }
            });

            try {
                const res = await fetch("{{ url_for('recruitment.acm_recruitment_form') }}", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const result = await res.json();
                alert(result.message || "Form submitted successfully.");
            } catch (err) {
                console.error(err);
                alert("Submission failed.");
            }
        });
    });
</script>

{% endblock %}