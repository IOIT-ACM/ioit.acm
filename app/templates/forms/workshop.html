{% extends "competitions/base.html" %}
{% block title %}Move Programming Workshop - Registration{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto p-4 md:p-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
        <div class="w-full flex justify-center mt-10 md:mt-10 p-2">
            <div class="w-1/2 md:mt-20 h-fit sticky top-32">
                <div
                    class="aspect-square bg-blue-500 w-1/2 h-auto transform absolute border border-white rounded-xl animate-rotate">
                </div>
                <div
                    class="aspect-square overflow-hidden bg-white w-full h-auto transform rotate-45 rounded-3xl border-4 border-white shadow-lg shadow-blue-400">
                    <img class="-rotate-45 z-50" src="{{ url_for('static', filename='og-image.png') }}" alt="about-image" />
                </div>
            </div></div>
        <div class="p-2 md:p-0">
            <div id="thankYouSection" class="hidden bg-white rounded-lg p-4 md:p-8 text-center">
                <div class="text-green-500 text-4xl md:text-5xl mb-4">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-2">Thank You for Registering!</h3>
                <p class="text-gray-600 text-sm md:text-base mb-6">Your registration for the Move Programming Workshop
                    has been successful.</p>
                <hr class="my-4 md:my-6" />
            </div>
            <form id="registrationForm" method="POST" class="space-y-4 md:space-y-6">
                <div id="step-0" class="form-step">
                    <div class="text-gray-700">
                        <h1 class="text-xl md:text-3xl font-bold text-blue-600 mb-4 md:mb-6 text-center">
                            Move Programming Workshop
                        </h1>

                        <div class="bg-white rounded-lg p-3 md:p-6 shadow-md mb-4 text-center">
                            <p class="text-sm md:text-base font-semibold text-gray-800">
                                <span class="inline-block mr-2"><i class="far fa-calendar-alt text-blue-500"></i></span>
                                July 21 &amp; 22, 2025<br class="md:hidden"> 09:00 AM – 3:00 PM
                            </p>
                            <p class="text-xs md:text-sm text-gray-600 mt-1">Venue: Classroom 016</p>
                        </div>

                        <div class="bg-white rounded-lg p-3 md:p-6 shadow-md mb-4 md:mb-6">
                            <h3 class="text-lg md:text-xl font-bold mb-2 md:mb-4 text-gray-800">Workshop Agenda</h3>
                            <div class="space-y-2 md:space-y-4">
                                <div class="border-l-4 border-blue-500 pl-2 md:pl-4">
                                    <h4 class="font-semibold text-blue-600 text-sm md:text-base">Day 1: Foundations</h4>
                                    <ul class="text-gray-700 text-xs md:text-sm space-y-1">
                                        <li>• Web3 and blockchain fundamentals</li>
                                        <li>• Introduction to Sui Network</li>
                                        <li>• Move programming language basics</li>
                                        <li>• Setting up development environment</li>
                                    </ul>
                                </div>
                                <div class="border-l-4 border-purple-500 pl-2 md:pl-4 mt-2 md:mt-0">
                                    <h4 class="font-semibold text-purple-600 text-sm md:text-base">Day 2: Hands-on
                                        Development</h4>
                                    <ul class="text-gray-700 text-xs md:text-sm space-y-1">
                                        <li>• Building Move modules</li>
                                        <li>• Testing and deployment on Sui testnet</li>
                                        <li>• Best practices and debugging</li>
                                        <li>• Career opportunities in Sui ecosystem</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <p id="already-submitted-msg"
                            class="text-center text-blue-600 text-sm md:text-base font-semibold hidden">
                            You have already submitted the registration form.
                        </p>
                        <div id="step-0-buttons" class="flex flex-col md:flex-row items-center gap-2 md:gap-4 mt-4">
                            <button type="button" onclick="nextStep()"
                                class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium md:font-bold py-2 px-4 rounded-lg transition text-sm md:text-base">
                                Begin Registration
                            </button>
                        </div>
                    </div>
                </div>
                <div id="step-1" class="form-step hidden">
                    <p class="text-base md:text-lg font-semibold text-gray-700 mb-4 md:mb-6">
                        Step 1: General Information
                    </p>
                    <hr class="border-t-2 border-gray-300 md:border-gray-500 my-4 md:my-6" />
                    <div class="mb-3 md:mb-4">
                        <label class="block text-gray-700 text-sm md:text-base font-semibold mb-1 md:mb-2">Full
                            Name</label>
                        <input type="text" id="fullName" name="fullName" placeholder="Enter full name"
                            class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div class="mb-3 md:mb-4">
                        <label class="block text-gray-700 text-sm md:text-base font-semibold mb-1 md:mb-2">Email</label>
                        <input type="email" id="email" name="email" placeholder="Enter email"
                            class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div class="mb-3 md:mb-4">
                        <label class="block text-gray-700 text-sm md:text-base font-semibold mb-1 md:mb-2">Contact
                            Number</label>
                        <input type="tel" id="contactNumber" name="contactNumber" placeholder="Enter contact number"
                            class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div class="mb-3 md:mb-4">
                        <label class="block text-gray-700 text-sm md:text-base font-semibold mb-1 md:mb-2">College Roll
                            / PRN</label>
                        <input type="text" id="collegeRoll" name="collegeRoll" placeholder="Enter college roll number"
                            class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div class="mb-3 md:mb-4">
                        <label class="block text-gray-700 text-sm md:text-base font-semibold mb-1 md:mb-2">Year of
                            Study</label>
                        <select id="yearOfStudy" name="yearOfStudy"
                            class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select your year</option>
                            <option value="FY">FY (First Year)</option>
                            <option value="SY">SY (Second Year)</option>
                            <option value="TY">TY (Third Year)</option>
                            <option value="BE">Final Year</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm md:text-base font-semibold mb-1 md:mb-2">Branch /
                            Department</label>
                        <select id="branch" name="branch"
                            class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select your branch</option>
                            <option value="CS">CS</option>
                            <option value="IT">IT</option>
                            <option value="AIDS">AI&DS</option>
                            <option value="Elec">Elec</option>
                            <option value="Instru">Instru</option>
                            <option value="Entc">Entc</option>
                        </select>
                    </div>
                    <button type="button" onclick="nextStep()"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium md:font-bold py-2 px-4 rounded-lg transition text-sm md:text-base">
                        Next
                    </button>
                </div>
                <div id="step-2" class="form-step hidden">
                    <p class="text-base md:text-lg font-semibold text-gray-700 mb-4 md:mb-6">
                        Step 2: Additional Information
                    </p>
                    <hr class="border-t-2 border-gray-300 md:border-gray-500 my-4 md:my-6" />
                    <div class="mb-3 md:mb-4">
                        <label class="block text-gray-700 text-sm md:text-base font-semibold mb-1 md:mb-2">Familiar with
                            Web3?</label>
                        <select id="web3Familiar" name="web3Familiar"
                            class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select option</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="mb-3 md:mb-4">
                        <label class="block text-gray-700 text-sm md:text-base font-semibold mb-1 md:mb-2">Heard of Sui
                            Network?</label>
                        <select id="suiNetwork" name="suiNetwork"
                            class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select option</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="mb-3 md:mb-4">
                        <label class="block text-gray-700 text-sm md:text-base font-semibold mb-1 md:mb-2">Languages
                            Known</label>
                        <textarea id="programmingLanguages" name="programmingLanguages" rows="3"
                            placeholder="e.g. Python, Rust, JavaScript"
                            class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="mb-3 md:mb-4">
                        <label
                            class="block text-gray-700 text-sm md:text-base font-semibold mb-1 md:mb-2">GitHub/Portfolio
                            (Optional)</label>
                        <input type="text" id="portfolio" name="portfolio" placeholder="Enter GitHub/Portfolio link"
                            class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div class="mb-4 md:mb-6">
                        <label class="flex items-start gap-2">
                            <input type="checkbox" id="agreement" name="agreement" class="mt-1" />
                            <span class="text-gray-700 text-xs md:text-sm">
                                I agree to attend both days of the workshop (July 21-22, 2025) and commit to the full
                                2-day program.
                            </span>
                        </label>
                    </div>
                    <div class="flex justify-between gap-2">
                        <button type="button" onclick="prevStep()"
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-black font-medium md:font-bold py-2 px-4 rounded-lg transition text-sm md:text-base">
                            Back
                        </button>
                        <button type="submit" id="submitBtn"
                            class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-medium md:font-bold py-2 px-4 rounded-lg transition text-sm md:text-base">
                            Submit
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    let currentStep = 0, formMemory = {};

    function saveFormData() {
        const form = document.getElementById('registrationForm');
        formMemory = {};
        form.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], textarea, select').forEach((element) => {
            if (!element.disabled && element.value.trim()) {
                formMemory[element.name] = element.value;
            }
        });
        form.querySelectorAll('input[type="radio"]:checked, input[type="checkbox"]:checked').forEach((element) => {
            formMemory[element.name] = element.value;
        });
        formMemory.currentStep = currentStep;
    }

    function loadFormData() {
        if (!Object.keys(formMemory).length) return;
        const form = document.getElementById('registrationForm');
        Object.keys(formMemory).forEach((name) => {
            if (name === 'currentStep') return;
            const elements = form.querySelectorAll(`[name="${name}"]:not([disabled])`);
            if (elements.length > 0) {
                const elementType = elements[0].type;
                if (elementType === 'radio' || elementType === 'checkbox') {
                    const selectedElement = form.querySelector(`[name="${name}"][value="${formMemory[name]}"]`);
                    if (selectedElement) {
                        selectedElement.checked = true;
                    }
                } else {
                    elements[0].value = formMemory[name];
                }
            }
        });
    }

    function goToStep(step, isLoading = false) {
        document.querySelectorAll('.form-step').forEach((div) => div.classList.add('hidden'));
        const stepElement = document.getElementById(`step-${step}`);
        if (stepElement) stepElement.classList.remove('hidden');
        currentStep = step;
        if (!isLoading) saveFormData();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function nextStep() {
        if (currentStep < 2) {
            if (validateStep(currentStep)) {
                goToStep(currentStep + 1);
            }
        }
    }

    function prevStep() {
        if (currentStep > 0) {
            goToStep(currentStep - 1);
        }
    }

    function validateStep(step) {
        const stepElement = document.getElementById(`step-${step}`);
        const formElement = document.getElementById('registrationForm');
        let fieldsToValidate = [];

        if (step === 1) {
            fieldsToValidate = ['fullName', 'email', 'contactNumber', 'collegeRoll', 'yearOfStudy', 'branch'];
        } else if (step === 2) {
            fieldsToValidate = ['web3Familiar', 'suiNetwork', 'programmingLanguages', 'agreement'];
        }

        let isValid = true;
        let firstInvalidField = null;

        stepElement.querySelectorAll('.border-red-500').forEach((element) => element.classList.remove('border-red-500'));
        stepElement.querySelectorAll('.error-msg').forEach((element) => element.remove());

        for (const fieldName of fieldsToValidate) {
            const elements = formElement.querySelectorAll(`[name="${fieldName}"]:not([disabled])`);
            if (!elements.length) continue;

            let hasValue = false;
            if (elements[0].type === 'checkbox') {
                hasValue = elements[0].checked;
            } else if (elements[0].type === 'radio') {
                hasValue = [...elements].some((radio) => radio.checked);
            } else {
                hasValue = elements[0].value.trim() !== '';
            }

            if (!hasValue) {
                isValid = false;
                elements.forEach((element) => {
                    const parent = element.closest('.radio-option') || element.closest('div');
                    element.classList.add('border-red-500');
                    if (parent && !parent.querySelector('.error-msg')) {
                        const message = document.createElement('p');
                        message.className = 'text-xs md:text-sm text-red-500 mt-1 error-msg';
                        message.innerText = 'This field is required.';
                        if (element.type === 'radio') {
                            const group = element.closest('div.gap-4') || element.closest('div.mb-6');
                            if (group && !group.querySelector('.error-msg')) {
                                group.appendChild(message);
                            }
                        } else {
                            parent.appendChild(message);
                        }
                    }
                });
                if (!firstInvalidField) firstInvalidField = elements[0];
            } else if (fieldName === 'email') {
                const emailInput = elements[0];
                const emailValue = emailInput.value.trim();
                const emailRegex = /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;
                if (!emailRegex.test(emailValue)) {
                    isValid = false;
                    const parent = emailInput.closest('div');
                    emailInput.classList.add('border-red-500');
                    if (parent && !parent.querySelector('.error-msg')) {
                        const message = document.createElement('p');
                        message.className = 'text-xs md:text-sm text-red-500 mt-1 error-msg';
                        message.innerText = 'Please enter a valid email address.';
                        parent.appendChild(message);
                    }
                    if (!firstInvalidField) firstInvalidField = emailInput;
                }
            } else if (fieldName === 'contactNumber') {
                const contactInput = elements[0];
                const contactValue = contactInput.value.trim();
                const contactRegex = /^\d{10}$/;
                if (!contactRegex.test(contactValue)) {
                    isValid = false;
                    const parent = contactInput.closest('div');
                    contactInput.classList.add('border-red-500');
                    if (parent && !parent.querySelector('.error-msg')) {
                        const message = document.createElement('p');
                        message.className = 'text-xs md:text-sm text-red-500 mt-1 error-msg';
                        message.innerText = 'Please enter a valid 10-digit contact number.';
                        parent.appendChild(message);
                    }
                    if (!firstInvalidField) firstInvalidField = contactInput;
                }
            }
        }

        if (!isValid && firstInvalidField) {
            firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        return isValid;
    }

    function setupAutoSave() {
        const storedData = localStorage.getItem('workshopRegistrationFormData');
        if (storedData) formMemory = JSON.parse(storedData);

        setInterval(() => {
            saveFormData();
            localStorage.setItem('workshopRegistrationFormData', JSON.stringify(formMemory));
        }, 5000);

        document.querySelectorAll('input, select, textarea').forEach((element) => {
            element.addEventListener('input', () => {
                saveFormData();
                localStorage.setItem('workshopRegistrationFormData', JSON.stringify(formMemory));
            });
            element.addEventListener('change', () => {
                saveFormData();
                localStorage.setItem('workshopRegistrationFormData', JSON.stringify(formMemory));
            });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        setupAutoSave();
        loadFormData();

        if (!formMemory.currentStep && formMemory.currentStep !== 0) {
            goToStep(0, true);
        }

        const alreadySubmitted = localStorage.getItem('workshopRegistrationSubmitted') === 'true';
        const buttons = document.getElementById('step-0-buttons');

        if (alreadySubmitted) {
            document.getElementById('already-submitted-msg').classList.remove('hidden');
            buttons.innerHTML = `
        <a href="/" class="w-full bg-gray-300 hover:bg-gray-400 text-black font-medium md:font-bold py-2 px-4 rounded-lg text-center text-sm md:text-base">
          Home
        </a>
        <button type="button" onclick="localStorage.removeItem('workshopRegistrationSubmitted'); localStorage.removeItem('workshopRegistrationFormData'); formMemory={}; goToStep(1);" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium md:font-bold py-2 px-4 rounded-lg transition text-sm md:text-base">
          Register Again
        </button>`;
        } else {
            buttons.innerHTML = `
        <button type="button" onclick="nextStep()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium md:font-bold py-2 px-4 rounded-lg transition text-sm md:text-base">
          Begin Registration
        </button>`;
        }

        document.querySelectorAll('input, select, textarea').forEach((element) => {
            element.addEventListener('input', () => {
                element.classList.remove('border-red-500');
                const parent = element.closest('.radio-option') || element.closest('div');
                const errorMessage = parent?.querySelector('.error-msg');
                if (errorMessage) errorMessage.remove();

                if (element.type === 'radio') {
                    const group = element.closest('div.gap-4') || element.closest('div.mb-6');
                    const groupMessage = group?.querySelector('.error-msg');
                    if (groupMessage) groupMessage.remove();
                }
            });
        });

        document.getElementById('registrationForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            if (!validateStep(2)) return;

            saveFormData();

            const submitButton = document.getElementById('submitBtn');
            submitButton.disabled = true;
            submitButton.innerText = 'Submitting...';

            try {
                const response = await fetch("/workshop", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formMemory),
                });

                if (response.ok) {
                    localStorage.setItem('workshopRegistrationSubmitted', 'true');
                    document.getElementById('registrationForm').classList.add('hidden');
                    document.getElementById('thankYouSection').classList.remove('hidden');
                } else {
                    console.error('Submission failed');
                    alert('Submission failed. Please try again.');
                    submitButton.innerText = 'Submit';
                    submitButton.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                submitButton.innerText = 'Submit';
                submitButton.disabled = false;
            }
        });

        window.addEventListener('beforeunload', () => {
            saveFormData();
            localStorage.setItem('workshopRegistrationFormData', JSON.stringify(formMemory));
        });
    });
</script>
{% endblock %}